<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="UI/style.css" rel="stylesheet">
    <script src="Common/Config.js"></script>
    <script src="Common/InternalMisuseError.js"></script>
    <script src="Common/Utils.js"></script>
    <script src="Board/BoardManager.js"></script>
    <script src="Entity/Base/EntityBase.js"></script>
    <script src="Entity/FoodEntity.js"></script>
    <script src="Entity/PlayerEntity.js"></script>
    <script src="Game/CanvasManager.js"></script>
    <script src="Game/GameData.js"></script>
    <script src="Game/GameManager.js"></script>
    <script src="Player/InputManager.js"></script>
    <script src="Player/Player.js"></script>
    <script src="Player/PlayerManager.js"></script>
    <script src="Player/Request.js"></script>
    <script src="UI/JoinForm.js"></script>
    <script src="UI/PlayerTable.js"></script>
    <script>
        // TODO: config really needs a refactor to handle 1) server IP different and 2) custom data from server like gridSize, maxPlayers, and map type? desert/grass whatever
        // TODO: maybe I'll go with addListener but by design I want to control the handler in a singular manner for now
        window.onload = () => {
            const byId = Utils.byId;
            const webSocket = new WebSocket("ws://" + Config.IP + ":" + Config.PORT);

            // TODO: probably bgcolor should come from server along with gridSize and maxPlayers
            const backgroundDesert = '#ECB978';
            const backgroundGrass = '#458a32';
            const backgroundSeed = Utils.ipToInt32(Config.IP === "localhost" ? "127.0.0.1" : Config.IP);
            const gridSize = Config.GRID_SIZE;
            const maxPlayers = Config.MAX_CONCURRENT;

            const gameData = new GameData();

            const canvasEl = byId('snake-canvas');
            const canvasManager = new CanvasManager(canvasEl, gridSize);
            const boardManager = new BoardManager(canvasManager, backgroundDesert, backgroundSeed, gameData);

            const joinContainerEl = byId('join-container');
            // TODO: should we just grab the button and input from container in JoinForm?
            const joinButtonEl = byId('join-button');
            const joinInputEl = byId('join-input');
            const joinForm = new JoinForm(joinContainerEl, joinButtonEl, joinInputEl, webSocket);

            const playerTableEl = byId('player-table');
            const playerTable = new PlayerTable(maxPlayers, playerTableEl)
            const inputManager = new InputManager(webSocket, window);
            const playerManager = new PlayerManager(gameData, inputManager, joinForm, maxPlayers, playerTable);

            const gameManager = new GameManager(boardManager, canvasManager, gameData, playerManager);

            webSocket.onmessage = (e) => gameManager.onMessage(e);
            window.onresize = () => gameManager.onResize();

            webSocket.onopen = () => {
                // TODO: shouldn't let the client spam server unless actually joined
                //   and join controller
                window.onkeydown = (e) => inputManager.onKeyDown(e);
                window.onkeyup = (e) => inputManager.onKeyUp(e);
            };

            webSocket.onclose = () => {
                webSocket.onopen = null;
                webSocket.onclose = null;
            };

            //boardManager.drawFull();
        };
    </script>
</head>
<body>
<canvas id="snake-canvas">Your browser does not support canvas.</canvas>
<div id="ui" style="bottom: 0; padding-bottom: 6px;">
    <table id="player-table"
           style="float: left; display: inline-block; width:auto; margin-left: auto; text-align: left">
        <tr style="width:auto; justify-content: center">
        <tr>
            <td>Player 1</td>
            <td>0</td>
        </tr>
        <tr>
            <td>Player 2</td>
            <td>0</td>
        </tr>
        <tr>
            <td>Player 3</td>
            <td>0</td>
        </tr>
        <tr>
            <td>Player 4</td>
            <td>0</td>
        </tr>
        <tr>
            <td>Player 5</td>
            <td>0</td>
        </tr>
    </table>
    <div id="join-container">
        <label for="join-input">Name </label><input id="join-input" name="name" type="text"/>
        <button id="join-button" type="submit">Join</button>
    </div>
</div>
</body>
</html>
